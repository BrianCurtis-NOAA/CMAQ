# Meteorology-Chemistry Interface Processor (MCIP)
The Meteorology-Chemistry Interface Processor (MCIP) processes meteorological model output from the WRF‑ARW model into I/O API-formatted files that are compatible with CMAQ and SMOKE (the emissions processor that computes emissions inputs to CMAQ). MCIP automatically determines whether an input file is generated by WRF‑ARW by trying to open the file as a netCDF file. If the file can be read as netCDF, MCIP assumes the input is a WRF‑ARW dataset.  MCIP can be used to uniformly trim cells off the lateral boundary of the domain defined by the meteorological model, or to window in on a subset of that domain. Configuration options for MCIP include the time periods over which to extract data from the meteorological model output files, horizontal and vertical grid definitions, and selections for integrating satellite cloud observations into MCIP output.

## Files, configuration, and environment variables

All MCIP configurations are accomplished at execution (rather than at compile time) and via Fortran namelist variables, a distinction from the rest of the CMAQ programs. The user does not need to directly edit the MCIP namelist file. All configuration settings are contained in the MCIP run script, which automatically creates a new namelist file each time the script is executed.

## MCIP Input Files

**Table 1. MCIP input files**

|**File Name**|**Format**|**Description**|
|------------|------------------------------|-----------------------------------------------------|
|InMetFiles|netCDF (WRF\‑ARW)|List of WRF‑ARW output files for input to MCIP|
|InSatFiles||GOES satellite cloud data|

##MCIP Output Files
**Table 2. MCIP output files**

|**File Name**|**Format**|**Description**|
|--------------------|-----------------|------------------------------------------------------------------|
|GRIDDESC|ASCII|Grid description file with coordinate and grid definition information|
|GRID_BDY_2D|BNDARY3|Time-independent 2-D boundary meteorology file|
|GRID_CRO_2D|GRDDED3|Time-independent 2-D cross-point meteorology file|
|GRID_CRO_3D|GRDDED3|Time-independent 3-D cross-point meteorology file|
|GRID_DOT_2D|GRDDED3|Time-independent 2-D dot-point meteorology file|
|MET_BDY_3D|BNDARY3|Time-dependent 3-D boundary meteorology file|
|MET_CRO_2D|GRDDED3|Time-dependent 2-D cross-point meteorology file|
|MET_CRO_3D|GRDDED3|Time-dependent 3-D cross-point meteorology file|
|MET_DOT_3D|GRDDED3|Time-dependent 3-D dot-point meteorology file|

The default location of the MCIP output files is the `$CMAQ_HOME/data/mcip/$GridName` directory. Since the default file names do not have any information about the model grid that they are simulating, the name of the grid is set in the output directory path. The default naming convention for all MCIP output files uses only the APPL environment variable in the file name. All of the file-naming variables for the MCIP outputs are set in the run script.

## Compilation Configuration

All model configuration options for MCIP are set during execution. System compiler options must be set in the provided Linux Makefile to build the program for different operating system/compiler combinations. Example compiler paths, flags, and library locations are provided in the default Makefile.

## Execution Configuration Variables

**>> Comment <<** These are not environment variables.  MCIP does not read environment variables like CCTM does.

The environment variables listed here are invoked during execution of the program and are set in the MCIP run script.

-   `APPL [default: None]`  
    Application name; scenario ID for file naming
-   `CoordName [default: None]`  
    Coordinate system name of the MCIP output grid that is written to the GRIDDESC file
-   `GridName [default: None]`  
    Model grid name of the MCIP output grid that is written to the GRIDDESC file
-   `DataPath [default: $CMAQ_DATA]`  
    Input/output data directory path
-   `InMetDir [default: None]`  
    Path of the input data directory containing the WRF‑ARW output data files
-   `InTerDir [default: None]`  
    Path of the input data directory containing the WRF Geogrid file
-   `InSatDir [default: None]`  
    Path of the input data directory containing GOES satellite files for using observed cloud cover data.
-   `OutDir [default: $CMAQ_HOME/data/mcip]`  
    Path of the MCIP output data directory
-   `ProgDir [default: $CMAQ_HOME/PREP/mcip/src]`  
    Working directory containing the MCIP executable
-   `WorkDir [default: $OutDir]`  
    Temporary working directory for Fortran links and the namelist file
-   `InMetFiles [default: None]`  
    List of input meteorology files, including the directory path for each file; without modifying MCIP, up to 300 meteorological model output files are allowed as input to a single MCIP execution
-   `InSatFiles [default: None]`  
    List of input GOES satellite cloud data files.
-   `IfTer [default: F]`  
    Binary flag indicating the availability of an input WRF Geogrid file; options include T (true) or F (false)
-   `InTerFile [default: None]`  
    Name and location of input WRF Geogrid file
-   `LPV: [default: 0]`  
    Compute and output potential vorticity. This must be activated to support the [CCTM O3 potential vorticity scaling](../../CCTM/docs/ReleaseNotes/Potential_Vorticity_Scaling.md).
    -   `0`: Do not compute and output potential vorticity
    -   `1`: Compute and output potential vorticity
-   `LWOUT [default: 0]`  
    Output vertical velocities.
    -   `0`: Do not output vertical velocity
    -   `1`: Output vertical velocity
-   `LUVCOUT [default: 0]`  
    Output u- and v-component winds on C-grid.
    -   `0`: Do not output u- and v-component winds on C-grid
    -   `1`: Output u- and v-component winds on C-grid
-   `LSAT [default: 0]`  
    Use GOES satellite cloud observations to replace model-derived input on clouds
    -   `0`: No satellite data are available
    -   `1`: Use GOES observed cloud information to replace model-derived input
-   `MCIP_START [format: YYYY-MM-DD-HH:MM:SS.SSSS]`  
    Beginning date and time (UTC) of data to output from MCIP. The start date and time must be contained within the input data from WRF‑ARW.
-   `MCIP_END [format: YYYY-MM-DD-HH:MM:SS.SSSS]`  
    End date and time (UTC) of data to output from MCIP. The end date and time must be contained within the input data from WRF‑ARW.
-   `INTVL [default: 60]`  
    Output interval in minutes. This setting determines the amount of model time contained in each output time step. The output interval for MCIP can be less frequent than the incoming meteorological model output (e.g., process 30-minute data for CCTM from 15-minute WRF‑ARW output).
-   `CTMLAYS [default: “-1.0” ]`  
    Sigma values of the vertical layers in the 3-D MCIP output. Comma-delimited values for each sigma value must be in descending order starting at 1 and ending with 0. There are a maximum of 100 layers allowed. To use the all of the layers from the input meteorology without collapsing (or explicitly specifying), set CTMLAYS = ‑1.0.
-   `MKGRID [default: T]`  
    Determines whether to output static (GRID) meteorology files
-   `BTRIM [default: 5]`  
    The number of boundary points to remove on each of the four horizontal sides of the MCIP domain. Setting BTRIM = 0 will specify the maximum extent of the input meteorology domain. To remove the WRF‑ARW lateral boundaries, set BTRIM = 5 (recommended).
    This setting affects the output MCIP horizontal domain by reducing the input meteorology domain by 2*BTRIM + 2*NTHIK + 1, where NTHIK is the lateral boundary thickness (from the BDY files). The extra point reflects the conversion from the grid points (dot points) to grid cells (cross points).
    For windowing a subset domain of the input meteorology, set BTRIM = -1; this setting causes BTRIM to be replaced by the information provided by X0, Y0, NCOLS, and NROWS (see below).
-   `X0 [used only if BTRIM = -1]`  
    The *x*-coordinate of the lower-left corner of the full MCIP cross-point domain (including the MCIP lateral boundary) based on the input WRF‑ARW domain. X0 refers to the east-west direction.
-   `Y0 [used only if BTRIM = -1]`  
    The *y*-coordinate of the lower-left corner of the full MCIP cross-point domain (including the MCIP lateral boundary) based on the input WRF‑ARW domain. Y0 refers to the north-south direction.
-   `NCOLS [used only if BTRIM = -1]`  
    Number of columns in the output MCIP domain (excluding MCIP lateral boundaries)
-   `NROWS [used only if BTRIM = -1]`  
    Number of rows in the output MCIP domain (excluding MCIP lateral boundaries)
-   `LPRT_COL [default: 0]`  
    Column cell coordinate for diagnostic outputs on the MCIP modeling domain
-   `LPRT_ROW [default: 0]`  
    Row cell coordinate for diagnostic outputs on the MCIP modeling domain
-   `WRF_LC_REF_LAT [default: -999.0]`  
    WRF Lambert Conformal reference latitude. Use this setting to force the reference latitude in the output MCIP data. If not set, MCIP will use the average of the two true latitudes.

## Compiling and Running

**Compile MCIP**

**>>COMMENT>>** Update or remove reference to chapter 5 from old User's document

[Chapter 5](CMAQ_OGD_ch05_sys_req.md) provides an overview of how to install and compile the CMAQ programs for the tutorial simulation. Follow the steps outlined in Chapter 5 (summarized below) to compile new versions of **MCIP**.

MCIP is compiled with a Makefile. The configuration options in the Makefile include only the compiler and compiler flags to use for building the executable. The Makefile is located in the directory with the MCIP source code (`$CMAQ_HOME/PREP/mcip/src`). To compile MCIP, source the config_cmaq.csh file and invoke the Makefile at the command line:

```
cd $CMAQ_HOME/PREP/mcip/src/
source $CMAQ_HOME/config_cmaq.csh
./make |& tee make.mcip.log
```

To port MCIP to different compilers, change the compiler names, locations, and flags in the config_cmaq.csh script.

**Run MCIP**

Set the run script settings according to the execution configuration variables described above. Run MCIP to produce meteorology input data for the CCTM:

```
cd $CMAQ_HOME/PREP/mcip/scripts
./run_mcip.csh |& tee run_mcip.log
```

**>>COMMENT<<** Consider update to output format to include both I/O API and netCDF.  And in the last bullet in this section, be sure to update output format.

MCIP ingests output files from meteorological models, including the [Weather Research and Forecasting Model (WRF)](http://www.wrf-model.org), to create meteorology files that are used within the CMAQ Modeling System. The goal of MCIP is to use as much of the data directly from the meteorological model to ensure physical consistency in the atmospheric state used by the CMAQ Modeling System. The output from MCIP is in the standard I/O API format that is used within the CMAQ Modeling System. MCIP output files can be used by the emissions processor (e.g., for meteorologically varying temperatures for mobile emissions) and by the CCTM to define the atmospheric conditions. An overview of MCIP can be found in Otte and Pleim (2010).

Using output fields from the meteorological model, MCIP performs the following functions:

-   Processes all required meteorological fields for CCTM and the emissions model. Meteorological fields such as atmospheric temperature, pressure, humidity, and winds are taken directly from the meteorological model (i.e., "passed through"). Additional fields that are required by the CCTM but are not part of the meteorological model's output stream are computed within MCIP from the available meteorological fields.
-    Extracts meteorological model output on the computational domain that is prescribed for the CCTM. The CCTM typically uses a smaller computational domain than the meteorological model, and the lateral boundaries from the meteorological model are generally not used by CCTM.
-   Optionally reduces the number of vertical layers from the meteorological model to the CCTM using "layer collapsing". To do this, MCIP uses mass-weighted averaging on higher-vertical-resolution meteorological model output.
-   Outputs several files in I/O API format that contain meteorological and geospatial information used by emissions processing and the CCTM.

MCIP is written in FORTRAN, and it runs on a single processor in a Unix/Linux environment. MCIP is driven by a C-shell script with several run-time options that are defined through a FORTRAN namelist. It is typical to use MCIP to process hourly output fields from the meteorological model for each one-day period.

MCIP is often updated concurrently with the CCTM.  The changes to MCIP are documented with each update to the software, and a "Frequently Asked Questions" (FAQ) file exists that is specific to MCIP.
